clear all
close all
clc

pname_SPF   = '/home/jspark/Documents/work/prjResidualStress/3D.MultiscaleCode3.Ti811/Final_SPF';
pname_odf   = '/home/jspark/Documents/work/prjResidualStress/3D.MultiscaleCode3.Ti811/Final_ODF';

angle_pos   = [0 90]';
radial_pos  = 1:1:21;

na  = length(angle_pos);
nr  = length(radial_pos);

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% COMPUTE DIRECTIONAL MODULUS
%%% e11, e22, e33, e12, e13, e23
%%% SHEARS ARE 2*HOSFORD
%%% Ti811
C   = [ ...
    141  76.9 57.9 0      0      0; ...
    76.9 141  57.9 0      0      0; ...
    59.7 57.9 163  0      0      0; ...
    0    0    0    2*32.1 0      0; ...
    0    0    0    0      2*48.7 0; ...
    0    0    0    0      0      2*48.7; ...
    ]

% %% Zirconium TOME
% C   = [ ...
%     143.5 72.5  65.4  0      0      0; ...
%     72.5  143.5 65.4  0      0      0; ...
%     65.4  65.4  164.9 0      0      0; ...
%     0     0     0     2*35.5 0      0; ...
%     0     0     0     0      2*32.1 0; ...
%     0     0     0     0      0      2*32.1; ...
%     ];

% %% Ti TOME
% C   = [ ...
%     162.4 92.0  69.0  0      0      0; ...
%     72.5  162.4 69.0  0      0      0; ...
%     65.4  65.4  180.7 0      0      0; ...
%     0     0     0     2*35.2 0      0; ...
%     0     0     0     0      2*46.7 0; ...
%     0     0     0     0      0      2*46.7; ...
%     ];
load wshex2x

% %%% TEST CASE - ISOTROPIC
% C   = [ ...
%     248 155 155   0   0   0; ...
%     155 248 155   0   0   0; ...
%     155 155 248   0   0   0; ...
%     0    0    0   2*124  0   0; ...
%     0    0    0   0   2*124  0; ...
%     0    0    0   0   0   2*124; ...
%     ];

% %% TEST CASE - CUBIC COPPER
% C   = [ ...
%     168   121.4 121.4 0      0      0; ...
%     121.4 168   121.4 0      0      0; ...
%     121.4 121.4 168   0      0      0; ...
%     0     0     0     2*75.4 0      0; ...
%     0     0     0     0      2*75.4 0; ...
%     0     0     0     0      0      2*75.4; ...
%     ];
% load wscub
% wshex2x = wscub;

RMat    = RMatOfQuat(QuatOfRod(wshex2x.frmesh.crd));
for i = 1:1:wshex2x.frmesh.numind
    T(:,:,i)    = VectorizedCOBMatrix(RMat(:,:,i));
end

for j = 1:1:nr
    for i = 1:1:na
        fname_odf   = ['odf_Alp', num2str(angle_pos(i)), ...
            '_pos', num2str(radial_pos(j)), '.mat'];
        pfname_odf  = fullfile(pname_odf, fname_odf);
        odf = load(pfname_odf);
        odf = odf.odf;
        
        odf = ones(wshex2x.frmesh.numind,1);    % ISOTROPIC TEXTURE (TYPICAL SIN2PSI APPROACH)
        
        for k = 1:1:wshex2x.frmesh.numind
            % Ck(:,:,k)   = RRt6(:,:,k)*C*RtR6(:,:,k);
            Ck(:,:,k)   = T(:,:,k)'*C*T(:,:,k);
        end
        
        for mm = 1:1:6
            for nn = 1:1:6
                C_MACRO{i,j}(mm,nn) = odf'*wshex2x.frmesh.l2ip*squeeze(Ck(mm,nn,:));
                C_MACRO{i,j}(mm,nn) = C_MACRO{i,j}(mm,nn)/sum(odf'*wshex2x.frmesh.l2ip);
            end
        end
        
        %%% SYMMETRIZE (THERE ARE SOME NUMERICAL ROUNDING ERROR 
        %%% C_MACRO{i,j} AS IS COMES OUT SLIGHTLY ASYMMETRIC
        C_MACRO{i,j}    = (C_MACRO{i,j} + C_MACRO{i,j}')/2;
        
        C11 = C_MACRO{i,j}(1,1);
        C12 = C_MACRO{i,j}(1,2);
        C44 = C_MACRO{i,j}(4,4);
        
        
        G   = C44/2;
        nu  = 0.5*(1 - 2*G / (C11 + C12));
        E   = C11 * (1 + nu) * (1 - 2*nu)/(1 - nu);
        
        % disp(C_MACRO{i,j});
        disp([E/(1+nu), E, nu, G])
    end
end